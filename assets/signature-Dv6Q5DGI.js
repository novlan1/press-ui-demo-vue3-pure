import{N as Y,Q as R,aB as O,O as Q,T as J,U as $,_ as j,r as b,o as S,c as F,a as L,b as V,w as z,t as T,e as w,k,G as H,n as K,d as Z}from"./index-DccXyPO9.js";import{g as G}from"./rect-o8Jq-PR4.js";import{a as M}from"./canvas-DG8Ww8fk.js";import{P as tt}from"./press-image-C8pUijlU.js";import{P as et,a as st}from"./press-grid-item-CglkbqeU.js";import"./press-transition-JizE2nFH.js";import"./system-Dmmn2gy0.js";import"./relation-Ce8eT7mn.js";import"./parent-map-12wGqNaT.js";import"./link-CZOkAvc-.js";function it(t,e,{lineColor:o="#1A1A1A",updateRadius:n,radius:s}){let a=s;const c=60,h=1,P=1.5,i=.5,p=4;if(e.length<=1){e[0].r=a;return}let l,f,d,u,m,g,v=0,_=0;const r=.5;e.length<=2?(l=e[1].x,u=e[1].y,d=e[1].x+(e[0].x-e[1].x)*r,g=e[1].y+(e[0].y-e[1].y)*r,f=l+(d-l)*r,m=u+(g-u)*r):(l=e[2].x+(e[1].x-e[2].x)*r,u=e[2].y+(e[1].y-e[2].y)*r,f=e[1].x,m=e[1].y,d=f+(e[0].x-f)*r,g=m+(e[0].y-m)*r);const X=q({x:d,y:g},{x:l,y:u}),W=a;for(let C=0;C<e.length-1&&(v+=e[C].dis,_+=e[C].time-e[C+1].time,!(v>c));C++);a=Math.min(_/X*h+i,p)*P,n(a),e[0].r=a;const I=5;let y=[];for(let C=0;C<I;C++){const x=C/(I-1),B=(1-x)*(1-x)*l+2*x*(1-x)*f+x*x*d,D=(1-x)*(1-x)*u+2*x*(1-x)*m+x*x*g,E=W+(a-W)/I*C;if(y.push({x:B,y:D,r:E}),y.length==3){const U=nt(y[0].x,y[0].y,y[0].r,y[1].x,y[1].y,y[1].r,y[2].x,y[2].y,y[2].r);U[0].color=o,at(t,U),y=[{x:B,y:D,r:E}]}}return e}function q(t,e){const o=e.x-t.x,n=e.y-t.y;return Math.sqrt(o*o+n*n)}function nt(t,e,o,n,s,a,c,h,P){const i=[];let p,l,f,d,u;p=n-t,l=s-e,f=Math.sqrt(p*p+l*l+1e-4)*2,p=p/f*o,l=l/f*o;const m=l,g=-p;d=n-c,u=s-h,f=Math.sqrt(d*d+u*u+1e-4)*2,d=d/f*P,u=u/f*P;const v=-u,_=d;i.push({mx:t+m,my:e+g,color:"#1A1A1A"}),i.push({c1x:n+m,c1y:s+g,c2x:n+v,c2y:s+_,ex:c+v,ey:h+_}),i.push({c1x:c+v-d,c1y:h+_-u,c2x:c-v-d,c2y:h-_-u,ex:c-v,ey:h-_}),i.push({c1x:n-v,c1y:s-_,c2x:n-m,c2y:s-g,ex:t-m,ey:e-g}),i.push({c1x:t-m-p,c1y:e-g-l,c2x:t+m-p,c2y:e+g-l,ex:t+m,ey:e+g}),i[0].mx=i[0].mx.toFixed(1),i[0].mx=parseFloat(i[0].mx),i[0].my=i[0].my.toFixed(1),i[0].my=parseFloat(i[0].my);for(let r=1;r<i.length;r++)i[r].c1x=i[r].c1x.toFixed(1),i[r].c1x=parseFloat(i[r].c1x),i[r].c1y=i[r].c1y.toFixed(1),i[r].c1y=parseFloat(i[r].c1y),i[r].c2x=i[r].c2x.toFixed(1),i[r].c2x=parseFloat(i[r].c2x),i[r].c2y=i[r].c2y.toFixed(1),i[r].c2y=parseFloat(i[r].c2y),i[r].ex=i[r].ex.toFixed(1),i[r].ex=parseFloat(i[r].ex),i[r].ey=i[r].ey.toFixed(1),i[r].ey=parseFloat(i[r].ey);return i}function at(t,e,o,n){t.beginPath(),t.moveTo(e[0].mx,e[0].my),t.setFillStyle(e[0].color),t.setStrokeStyle(e[0].color);for(let s=1;s<e.length;s++)t.bezierCurveTo(e[s].c1x,e[s].c1y,e[s].c2x,e[s].c2y,e[s].ex,e[s].ey);t.stroke(),t.fill(),t.draw(!0)}const ot=()=>{var e;const t=document.createElement("canvas");return!!((e=t.getContext)!=null&&e.call(t,"2d"))};let N=0;const rt={name:"PressSignature",components:{PressButton:Y},options:{styleIsolation:"shared"},props:{customClass:{type:String,default:""},tips:{type:String,default:""},type:{type:String,default:""},penColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},backgroundColor:{type:String,default:"#fff"},clearButtonText:{type:String,default:R("clear")},confirmButtonText:{type:String,default:R("confirm")}},emits:["start","signing","end","submit","clear"],data(){return{canvasRect:{},canvasWidth:0,canvasHeight:0,id:1,inited:!1,ctx:null,wrapId:"pressSignatureWrap",currentLine:[],lastPoint:{},currentPoint:{},firstTouch:!0,cutArea:{},radius:1,canvas:null}},computed:{canvasId(){return`press-signature-${this.id}`},isRenderCanvas(){let t=!0;return t=O?ot():!0,t},useRawCanvas(){let t=!1;return t=!0,Q()&&(t=!0),t}},watch:{windowWidth(){this.resize()}},created(){N+=1,this.id=N},mounted(){this.initialize()},methods:{touchStart(t){if(!this.ctx)return!1;this.useRawCanvas?(this.ctx.beginPath(),this.ctx.setLineWidth(this.lineWidth),this.ctx.setStrokeStyle(this.penColor)):this.updateCurrentLine(t,!0),G(this,`#${this.canvasId}`).then(e=>{this.canvasRect=e,this.$emit("start")})},pointToLine(t){const e=it(this.ctx,t,{lineColor:this.penColor,updateRadius:o=>{this.radius=o},radius:this.radius,lineWidth:this.lineWidth,penColor:this.penColor});e&&(this.currentLine=e)},updateCurrentLine(t,e=!1){const o={x:t.changedTouches[0].x,y:t.changedTouches[0].y};this.lastPoint=this.currentPoint,this.currentPoint=o;const{currentLine:n}=this;n.unshift({time:new Date().getTime(),dis:e?0:q(this.currentPoint,this.lastPoint),x:o.x,y:o.y}),this.pointToLine(n)},touchMove(t){var e,o,n,s;if(!this.ctx)return!1;if((e=t.preventDefault)==null||e.call(t),(o=t.stopPropagation)==null||o.call(t),this.useRawCanvas){const a=t.touches[0],c=a.clientX-(((n=this.canvasRect)==null?void 0:n.left)||0),h=a.clientY-(((s=this.canvasRect)==null?void 0:s.top)||0);this.ctx.setLineCap("round"),this.ctx.setLineJoin("round"),this.ctx.lineTo(c,h),this.ctx.stroke()}else this.updateCurrentLine(t);this.$emit("signing",t)},touchEnd(t){var e;(e=t.preventDefault)==null||e.call(t),this.$emit("end"),this.useRawCanvas||(this.updateCurrentLine(t),this.currentLine=[])},submit(){var e,o;const t=this;if(this.useRawCanvas){const n=this.$refs.canvasRef;if(!n)return;const a=this.isCanvasEmpty(n)?"":((o=(e={jpg:()=>n.toDataURL("image/jpeg",.8),jpeg:()=>n.toDataURL("image/jpeg",.8)})[this.type])==null?void 0:o.call(e))||n.toDataURL(`image/${this.type}`);this.$emit("submit",{image:a,canvas:n,width:this.canvasWidth,height:this.canvasHeight})}else(()=>{uni.canvasToTempFilePath({canvas:this.canvas,fileType:"jpg",quality:1,success(s){const a=s.tempFilePath;t.base64(a,"jpg").then(c=>{t.$emit("submit",{image:c,canvas:t.canvas,width:t.canvasWidth,height:t.canvasHeight})})},fail(){}})})()},base64(t,e){return new Promise((o,n)=>{uni.getFileSystemManager().readFile({filePath:t,encoding:"base64",success(s){o(`data:image/${e.toLocaleLowerCase()};base64,${s.data}`)},fail(){n()}})})},clear(){this.ctx&&(this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.closePath(),this.ctx.draw(),this.setCanvasBgColor(this.ctx)),this.$emit("clear")},initialize(){this.isRenderCanvas&&this.getContext().then(t=>{this.ctx=t,this.setCanvasBgColor(this.ctx)})},getContext(){const t=this;return new Promise((e,o)=>{G(this,`#${this.wrapId}`).then(n=>{const{width:s,height:a}=n;t.canvasWidth=s,t.canvasHeight=a;const c=t.innerGetContext({width:s,height:a});e(c)}).catch(n=>{o(n)})})},innerGetContext({width:t,height:e}){const o=()=>{const s=window.devicePixelRatio,a=document.getElementById(this.canvasId),c=a.getContext("2d");return this.inited||(this.inited=!0,a.width=t*s,a.height=e*s,c.scale(s,s)),Promise.resolve(M(c))};if(this.useRawCanvas)return o();if(!J()){const s=uni.createCanvasContext(this.canvasId,this);return Promise.resolve(s)}const n=$().pixelRatio;return new Promise(s=>{uni.createSelectorQuery().in(this).select(`#${this.canvasId}`).node().exec(a=>{const c=a[0].node;this.canvas=c;const h=c.getContext("2d");this.inited||(this.inited=!0,c.width=t*n,c.height=e*n,h.scale(n,n)),s(M(h))})})},resize(){if(this.ctx){const t=this.ctx.getImageData(0,0,this.canvasWidth,this.canvasHeight);this.initialize(),this.ctx.putImageData(t,0,0)}},isCanvasEmpty(t){const e=document.createElement("canvas");if(e.width=t.width,e.height=t.height,this.backgroundColor){const o=e.getContext("2d");this.setCanvasBgColor(o)}return t.toDataURL()===e.toDataURL()},setCanvasBgColor(t){var e,o;t&&this.backgroundColor&&(t.fillStyle=this.backgroundColor,(e=t.setFillStyle)==null||e.call(t,this.backgroundColor),t.fillRect(0,0,this.canvasWidth,this.canvasHeight),(o=t.draw)==null||o.call(t))},t:R}},ct=["id"],lt={key:1},ht={class:"press-signature__footer"};function ut(t,e,o,n,s,a){const c=b("Canvas"),h=b("PressButton");return S(),F("div",{class:K(["press-signature",o.customClass])},[L("div",{id:s.wrapId,ref:"wrapRef",class:"press-signature__content"},[a.isRenderCanvas?(S(),V(c,{key:0,id:a.canvasId,ref:"canvasRef",type:"2d","canvas-id":a.canvasId,onTouchstartPassive:a.touchStart,onTouchmove:z(a.touchMove,["prevent","stop"]),onTouchend:z(a.touchEnd,["prevent","stop"])},null,8,["id","canvas-id","onTouchstartPassive","onTouchmove","onTouchend"])):(S(),F("p",lt,T(o.tips),1))],8,ct),L("div",ht,[w(h,{"custom-class":"press-signature__button press-signature__button--clear",size:"small",onClick:a.clear},{default:k(()=>[H(T(o.clearButtonText||a.t("clear")),1)]),_:1},8,["onClick"]),w(h,{"custom-class":"press-signature__button press-signature__submit",type:"primary",size:"small",onClick:a.submit},{default:k(()=>[H(T(o.confirmButtonText||a.t("confirm")),1)]),_:1},8,["onClick"])])],2)}const dt=j(rt,[["render",ut],["__scopeId","data-v-15283800"]]),A={"pen-color":"#000","line-width":3,"background-color":"#fff"},mt={i18n:{"zh-CN":{penColor:"自定义颜色",lineWidth:"自定义线宽",backgroundColor:"自定义背景颜色"},"en-US":{penColor:"Pen Color",lineWidth:"Line Width",backgroundColor:"Background Color"}},components:{PressSignature:dt,PressImage:tt,PressGrid:et,PressGridItem:st},data(){return{image:"",canvasWidth:"calc(100vw - 16px)",canvasHeight:200,customStyle:"background: transparent",sectionStyle:"padding: 0 0",customInfo:{...A}}},methods:{onSubmit(t){console.log("[onSubmit]",t);const{image:e,width:o,height:n}=t;this.image=e,this.canvasWidth=o,this.canvasHeight=n},onClear(){},custom(t){this.customInfo={...A,...t},setTimeout(()=>{this.$refs.pressSignature.clear()})}}},gt={class:"demo-wrap"},pt={class:"image-wrap"};function ft(t,e,o,n,s,a){const c=b("PressSignature"),h=b("PressImage"),P=b("demo-block"),i=b("PressGridItem"),p=b("PressGrid");return S(),F("div",gt,[w(P,{title:t.t("basicUsage"),"section-style":s.sectionStyle,"custom-style":s.customStyle},{default:k(()=>[w(c,{ref:"pressSignature","pen-color":s.customInfo["pen-color"],"line-width":s.customInfo["line-width"],"background-color":s.customInfo["background-color"],onSubmit:a.onSubmit,onClear:a.onClear},null,8,["pen-color","line-width","background-color","onSubmit","onClear"]),L("div",pt,[s.image?(S(),V(h,{key:0,src:s.image,width:s.canvasWidth,height:s.canvasHeight},null,8,["src","width","height"])):Z("",!0)])]),_:1},8,["title","section-style","custom-style"]),w(p,{clickable:"","column-num":3},{default:k(()=>[w(i,{text:t.t("penColor"),icon:"edit",onClick:e[0]||(e[0]=l=>a.custom({"pen-color":"#ff0000"}))},null,8,["text"]),w(i,{text:t.t("lineWidth"),icon:"font-o",onClick:e[1]||(e[1]=l=>a.custom({"line-width":6}))},null,8,["text"]),w(i,{text:t.t("backgroundColor"),icon:"photo-o",onClick:e[2]||(e[2]=l=>a.custom({"background-color":"#eee"}))},null,8,["text"])]),_:1})])}const It=j(mt,[["render",ft],["__scopeId","data-v-4afa9c71"]]);export{It as default};
