import{P as O,a as Q}from"./press-grid-D8i715u0.js";import{P as J}from"./press-image-CB2VHr5O.js";import{g as z,a as Z}from"./rect-Cp7IcEgF.js";import{_ as V,R as F,Q as K,Y as M,Z as $,i as tt,aD as et,r as P,c as k,o as S,b as L,w as U,t as T,e as w,h as I,H as G,n as st,d as it,a as nt}from"./index-DImLPMl-.js";import{a as N}from"./canvas-DG8Ww8fk.js";import"./relation-DncSzthF.js";function at(e,t,{lineColor:o="#1A1A1A",updateRadius:a,radius:s}){let i=s;const c=60,l=1,_=1.5,n=.5,p=4;if(t.length<=1){t[0].r=i;return}let h,f,d,u,m,g,v=0,b=0;const r=.5;t.length<=2?(h=t[1].x,u=t[1].y,d=t[1].x+(t[0].x-t[1].x)*r,g=t[1].y+(t[0].y-t[1].y)*r,f=h+(d-h)*r,m=u+(g-u)*r):(h=t[2].x+(t[1].x-t[2].x)*r,u=t[2].y+(t[1].y-t[2].y)*r,f=t[1].x,m=t[1].y,d=f+(t[0].x-f)*r,g=m+(t[0].y-m)*r);const X=q({x:d,y:g},{x:h,y:u}),W=i;for(let C=0;C<t.length-1&&(v+=t[C].dis,b+=t[C].time-t[C+1].time,!(v>c));C++);i=Math.min(b/X*l+n,p)*_,a(i),t[0].r=i;const R=5;let y=[];for(let C=0;C<R;C++){const x=C/(R-1),B=(1-x)*(1-x)*h+2*x*(1-x)*f+x*x*d,D=(1-x)*(1-x)*u+2*x*(1-x)*m+x*x*g,E=W+(i-W)/R*C;if(y.push({x:B,y:D,r:E}),y.length==3){const H=ot(y[0].x,y[0].y,y[0].r,y[1].x,y[1].y,y[1].r,y[2].x,y[2].y,y[2].r);H[0].color=o,rt(e,H),y=[{x:B,y:D,r:E}]}}return t}function q(e,t){const o=t.x-e.x,a=t.y-e.y;return Math.sqrt(o*o+a*a)}function ot(e,t,o,a,s,i,c,l,_){const n=[];let p,h,f,d,u;p=a-e,h=s-t,f=Math.sqrt(p*p+h*h+1e-4)*2,p=p/f*o,h=h/f*o;const m=h,g=-p;d=a-c,u=s-l,f=Math.sqrt(d*d+u*u+1e-4)*2,d=d/f*_,u=u/f*_;const v=-u,b=d;n.push({mx:e+m,my:t+g,color:"#1A1A1A"}),n.push({c1x:a+m,c1y:s+g,c2x:a+v,c2y:s+b,ex:c+v,ey:l+b}),n.push({c1x:c+v-d,c1y:l+b-u,c2x:c-v-d,c2y:l-b-u,ex:c-v,ey:l-b}),n.push({c1x:a-v,c1y:s-b,c2x:a-m,c2y:s-g,ex:e-m,ey:t-g}),n.push({c1x:e-m-p,c1y:t-g-h,c2x:e+m-p,c2y:t+g-h,ex:e+m,ey:t+g}),n[0].mx=n[0].mx.toFixed(1),n[0].mx=parseFloat(n[0].mx),n[0].my=n[0].my.toFixed(1),n[0].my=parseFloat(n[0].my);for(let r=1;r<n.length;r++)n[r].c1x=n[r].c1x.toFixed(1),n[r].c1x=parseFloat(n[r].c1x),n[r].c1y=n[r].c1y.toFixed(1),n[r].c1y=parseFloat(n[r].c1y),n[r].c2x=n[r].c2x.toFixed(1),n[r].c2x=parseFloat(n[r].c2x),n[r].c2y=n[r].c2y.toFixed(1),n[r].c2y=parseFloat(n[r].c2y),n[r].ex=n[r].ex.toFixed(1),n[r].ex=parseFloat(n[r].ex),n[r].ey=n[r].ey.toFixed(1),n[r].ey=parseFloat(n[r].ey);return n}function rt(e,t,o,a){e.beginPath(),e.moveTo(t[0].mx,t[0].my),e.setFillStyle(t[0].color),e.setStrokeStyle(t[0].color);for(let s=1;s<t.length;s++)e.bezierCurveTo(t[s].c1x,t[s].c1y,t[s].c2x,t[s].c2y,t[s].ex,t[s].ey);e.stroke(),e.fill(),e.draw(!0)}const ct=()=>{var t;const e=document.createElement("canvas");return!!((t=e.getContext)!=null&&t.call(e,"2d"))};let A=0,Y=null;const lt={name:"PressSignature",components:{PressButton:K},options:{styleIsolation:"shared"},props:{customClass:{type:String,default:""},tips:{type:String,default:""},type:{type:String,default:""},penColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},backgroundColor:{type:String,default:"#fff"},clearButtonText:{type:String,default:F("clear")},confirmButtonText:{type:String,default:F("confirm")},fileType:{type:String,default:"jpg"}},emits:["start","signing","end","submit","clear"],data(){return{canvasRect:{},canvasWidth:0,canvasHeight:0,id:1,inited:!1,ctx:null,wrapId:"pressSignatureWrap",currentLine:[],lastPoint:{},currentPoint:{},radius:1,canvas:null}},computed:{canvasId(){return`press-signature-${this.id}`},isRenderCanvas(){let e=!0;return e=et?ct():!0,e},useRawCanvas(){let e=!1;return e=!0,tt()&&(e=!0),e}},watch:{windowWidth(){this.resize()}},created(){A+=1,this.id=A},mounted(){this.initialize()},methods:{touchStart(e){if(!this.ctx)return!1;this.useRawCanvas?(this.ctx.beginPath(),this.ctx.setLineWidth(this.lineWidth),this.ctx.setStrokeStyle(this.penColor)):this.updateCurrentLine(e,!0),z(this,`#${this.canvasId}`).then(t=>{this.canvasRect=t,this.$emit("start")})},pointToLine(e){const t=at(this.ctx,e,{lineColor:this.penColor,updateRadius:o=>{this.radius=o},radius:this.radius,lineWidth:this.lineWidth,penColor:this.penColor});t&&(this.currentLine=t)},updateCurrentLine(e,t=!1){const o={x:e.changedTouches[0].x,y:e.changedTouches[0].y};this.lastPoint=this.currentPoint,this.currentPoint=o;const{currentLine:a}=this;a.unshift({time:new Date().getTime(),dis:t?0:q(this.currentPoint,this.lastPoint),x:o.x,y:o.y}),this.pointToLine(a)},touchMove(e){var t,o,a,s;if(!this.ctx)return!1;if((t=e.preventDefault)==null||t.call(e),(o=e.stopPropagation)==null||o.call(e),this.useRawCanvas){const i=e.touches[0],c=i.clientX-(((a=this.canvasRect)==null?void 0:a.left)||0),l=Z(i.clientY)-(((s=this.canvasRect)==null?void 0:s.top)||0);this.ctx.setLineCap("round"),this.ctx.setLineJoin("round"),this.ctx.lineTo(c,l),this.ctx.stroke(),M()||this.ctx.draw(!0)}else this.updateCurrentLine(e);this.$emit("signing",e)},touchEnd(e){var t;(t=e.preventDefault)==null||t.call(e),this.$emit("end"),this.useRawCanvas||(this.updateCurrentLine(e),this.currentLine=[])},submit(){var t,o;const e=this;if(this.useRawCanvas){const a=this.$refs.canvasRef;if(!a)return;const i=this.isCanvasEmpty(a)?"":((o=(t={jpg:()=>a.toDataURL("image/jpeg",.8),jpeg:()=>a.toDataURL("image/jpeg",.8)})[this.type])==null?void 0:o.call(t))||a.toDataURL(`image/${this.type}`);this.$emit("submit",{image:i,canvas:a,width:this.canvasWidth,height:this.canvasHeight})}else(()=>{let{canvas:s}=this;s=Y,uni.canvasToTempFilePath({canvas:s,canvasId:this.canvasId,fileType:this.fileType,quality:1,success(i){const c=i.tempFilePath;e.base64(c,"jpg").then(l=>{e.$emit("submit",{image:l,canvas:e.canvas,width:e.canvasWidth,height:e.canvasHeight})})},fail(i){console.warn("[canvasToTempFilePath] error: ",i)}},this)})()},base64(e,t){return new Promise((o,a)=>{uni.getFileSystemManager().readFile({filePath:e,encoding:"base64",success(s){o(`data:image/${t.toLocaleLowerCase()};base64,${s.data}`)},fail(){a()}})})},innerClear(){this.ctx&&(this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.closePath(),this.ctx.draw(),this.setCanvasBgColor(this.ctx))},clear(){this.innerClear(),this.$emit("clear")},initialize(){this.isRenderCanvas&&this.getContext().then(e=>{this.ctx=e,this.innerClear()})},getContext(){const e=this;return new Promise((t,o)=>{z(this,`#${this.wrapId}`).then(a=>{const{width:s,height:i}=a;e.canvasWidth=s,e.canvasHeight=i;const c=e.innerGetContext({width:s,height:i});t(c)}).catch(a=>{o(a)})})},innerGetContext({width:e,height:t}){const o=()=>{const s=window.devicePixelRatio,i=document.getElementById(this.canvasId),c=i.getContext("2d");return this.inited||(this.inited=!0,i.width=e*s,i.height=t*s,c.scale(s,s)),Promise.resolve(N(c))};if(this.useRawCanvas)return o();if(!M()){const s=uni.createCanvasContext(this.canvasId,this);return this.inited=!0,s.scale(a,a),Promise.resolve(s)}const a=$().pixelRatio;return new Promise(s=>{uni.createSelectorQuery().in(this).select(`#${this.canvasId}`).node().exec(i=>{const c=i[0].node;this.canvas=c,Y=c;const l=c.getContext("2d");this.inited||(this.inited=!0,c.width=e*a,c.height=t*a,l.scale(a,a)),s(N(l))})})},resize(){if(this.ctx){const e=this.ctx.getImageData(0,0,this.canvasWidth,this.canvasHeight);this.initialize(),this.ctx.putImageData(e,0,0)}},isCanvasEmpty(e){const t=document.createElement("canvas");if(t.width=e.width,t.height=e.height,this.backgroundColor){const o=t.getContext("2d");this.setCanvasBgColor(o)}return e.toDataURL()===t.toDataURL()},setCanvasBgColor(e){var t,o;e&&this.backgroundColor&&(e.fillStyle=this.backgroundColor,(t=e.setFillStyle)==null||t.call(e,this.backgroundColor),e.fillRect(0,0,this.canvasWidth,this.canvasHeight),(o=e.draw)==null||o.call(e))},t:F}},ht=["id"],ut=["id","canvas-id"],dt={key:1},mt={class:"press-signature__footer"};function gt(e,t,o,a,s,i){const c=P("PressButton");return S(),k("div",{class:st(["press-signature",o.customClass])},[L("div",{id:s.wrapId,ref:"wrapRef",class:"press-signature__content"},[i.isRenderCanvas?(S(),k("Canvas",{key:0,id:i.canvasId,ref:"canvasRef",type:"2d","canvas-id":i.canvasId,onTouchstartPassive:t[0]||(t[0]=(...l)=>i.touchStart&&i.touchStart(...l)),onTouchmove:t[1]||(t[1]=U((...l)=>i.touchMove&&i.touchMove(...l),["prevent","stop"])),onTouchend:t[2]||(t[2]=U((...l)=>i.touchEnd&&i.touchEnd(...l),["prevent","stop"]))},null,40,ut)):(S(),k("p",dt,T(o.tips),1))],8,ht),L("div",mt,[w(c,{"custom-class":"press-signature__button press-signature__button--clear",size:"small",onClick:i.clear},{default:I(()=>[G(T(o.clearButtonText||i.t("clear")),1)]),_:1},8,["onClick"]),w(c,{"custom-class":"press-signature__button press-signature__submit",type:"primary",size:"small",onClick:i.submit},{default:I(()=>[G(T(o.confirmButtonText||i.t("confirm")),1)]),_:1},8,["onClick"])])],2)}const pt=V(lt,[["render",gt],["__scopeId","data-v-e9d9bd94"]]),j={"pen-color":"#000","line-width":3,"background-color":"#fff"},ft={i18n:{"zh-CN":{penColor:"自定义颜色",lineWidth:"自定义线宽",backgroundColor:"自定义背景颜色"},"en-US":{penColor:"Pen Color",lineWidth:"Line Width",backgroundColor:"Background Color"}},components:{PressSignature:pt,PressImage:J,PressGrid:Q,PressGridItem:O},data(){return{image:"",canvasWidth:"calc(100vw - 16px)",canvasHeight:200,customStyle:"background: transparent",sectionStyle:"padding: 0 0",customInfo:{...j}}},methods:{onSubmit(e){console.log("[onSubmit]",e);const{image:t,width:o,height:a}=e;this.image=t,this.canvasWidth=o,this.canvasHeight=a},onClear(){},custom(e){this.customInfo={...j,...e},setTimeout(()=>{this.$refs.pressSignature.clear()})}}},yt={class:"demo-wrap"},xt={class:"image-wrap"};function Ct(e,t,o,a,s,i){const c=P("PressSignature"),l=P("PressImage"),_=P("demo-block"),n=P("PressGridItem"),p=P("PressGrid");return S(),k("div",yt,[w(_,{title:e.t("basicUsage"),"section-style":s.sectionStyle,"custom-style":s.customStyle},{default:I(()=>[w(c,{ref:"pressSignature","pen-color":s.customInfo["pen-color"],"line-width":s.customInfo["line-width"],"background-color":s.customInfo["background-color"],onSubmit:i.onSubmit,onClear:i.onClear},null,8,["pen-color","line-width","background-color","onSubmit","onClear"]),L("div",xt,[s.image?(S(),it(l,{key:0,src:s.image,width:s.canvasWidth,height:s.canvasHeight},null,8,["src","width","height"])):nt("",!0)])]),_:1},8,["title","section-style","custom-style"]),w(p,{clickable:"","column-num":3},{default:I(()=>[w(n,{text:e.t("penColor"),icon:"edit",onClick:t[0]||(t[0]=h=>i.custom({"pen-color":"#ff0000"}))},null,8,["text"]),w(n,{text:e.t("lineWidth"),icon:"font-o",onClick:t[1]||(t[1]=h=>i.custom({"line-width":6}))},null,8,["text"]),w(n,{text:e.t("backgroundColor"),icon:"photo-o",onClick:t[2]||(t[2]=h=>i.custom({"background-color":"#eee"}))},null,8,["text"])]),_:1})])}const kt=V(ft,[["render",Ct],["__scopeId","data-v-8eb5f4d1"]]);export{kt as default};
